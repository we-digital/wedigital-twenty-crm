name: Deploy Twenty CRM to DO

on:
  push:
    branches:
      - main

jobs:
  build-widgets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image-name.outputs.name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.SUBMODULE_PAT || secrets.GITHUB_TOKEN }}

      - name: Update submodules to latest main
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive --remote

      - name: Set image name
        id: image-name
        run: echo "name=ghcr.io/$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')/twenty-widgets:latest" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push widgets image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: packages/twenty-docker/twenty-widgets/Dockerfile
          push: true
          tags: ${{ steps.image-name.outputs.name }}
          build-args: |
            VITE_TWENTY_URL=${{ secrets.VITE_TWENTY_URL }}
            VITE_SCANNER_POLL_URL=${{ secrets.VITE_SCANNER_POLL_URL }}

      - name: Verify widget-mrz-input in image
        run: |
          IMAGE="ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')/twenty-widgets:latest"
          docker pull $IMAGE
          docker run --rm $IMAGE ls -la /usr/share/nginx/html/wedigital/mrz-input/
          docker run --rm $IMAGE ls /usr/share/nginx/html/wedigital/mrz-input/assets/ 2>/dev/null || echo "assets dir empty or missing"


  deploy:
    runs-on: ubuntu-latest
    needs: build-widgets
    permissions:
      packages: read
    steps:
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DO_SSH_KEY }}

      - name: Add server to known_hosts
        run: ssh-keyscan -H ${{ secrets.DO_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Check SSH connection
        run: ssh -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_IP }} "whoami && pwd"

      - name: Login to ghcr.io on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_IP }} \
            "echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin"

      - name: Deploy via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_IP }} << 'EOF'
            cd ~/wedigital-twenty-crm
            git fetch origin main
            git reset --hard origin/main
            git submodule sync --recursive
            git submodule update --init --recursive --remote || true
            export WIDGETS_IMAGE="${{ needs.build-widgets.outputs.image }}"
            docker compose -f docker-compose.prod.yml pull widgets server
            docker compose -f docker-compose.prod.yml up -d
          EOF

      - name: Show server logs on failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_IP }} << 'EOF'
            docker logs twenty-server-1 --tail 100 2>&1 || echo 'Could not get server logs'
            echo "--- front dir check ---"
            docker exec twenty-server-1 ls /app/packages/twenty-server/dist/front 2>&1 || echo 'dist/front not found'
            echo "--- root endpoint check ---"
            docker exec twenty-server-1 curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/ 2>&1
          EOF
